---
title: Authentication Module
---

## Authentication Module

### Overview

The Authentication module handles user authentication, authorization, and password management. It uses JWT tokens stored in HttpOnly cookies for secure authentication and implements role-based access control (RBAC).

### Features

- ✅ Super Admin initialization (one-time setup)
- ✅ JWT-based authentication with HttpOnly cookies
- ✅ Role-based access control (RBAC)
- ✅ Password change functionality
- ✅ User session management

### User Roles

The system supports the following roles:

- `super_admin` - Platform administrator (no company association)
- `company_admin` - Company administrator
- `hr_manager` - HR Manager
- `manager` - Department Manager
- `employee` - Regular employee

### Endpoints

#### 1. Create Super Admin

**GET** `/auth/super-admin`

- **Description**: Returns an HTML form for creating the first super admin user
- **Access**: Public (one-time setup)
- **Response**: HTML form page

**POST** `/auth/super-admin`

- **Description**: Creates the first super admin user (can only be created once)
- **Access**: Public (one-time setup)
- **Request Body**:
  ```json
  {
    "email": "admin@example.com",
    "password": "SecurePassword123",
    "fullName": "John Doe",
    "phone": "+1234567890"
  }
  ```
- **Response** (201 Created):
  ```json
  {
    "message": "Super admin created successfully",
    "user": {
      "id": "uuid",
      "email": "admin@example.com",
      "fullName": "John Doe",
      "role": "super_admin"
    }
  }
  ```
- **Errors**:
  - `409 Conflict`: Super admin already exists or email already in use

#### 2. Login

**POST** `/auth/login`

- **Description**: Authenticates user and sets JWT token in HttpOnly cookie
- **Access**: Public
- **Request Body**:
  ```json
  {
    "email": "admin@example.com",
    "password": "SecurePassword123"
  }
  ```
- **Response** (200 OK):
  ```json
  {
    "message": "Login successful",
    "user": {
      "id": "uuid",
      "email": "admin@example.com",
      "fullName": "John Doe",
      "role": "super_admin",
      "companyId": null
    }
  }
  ```
- **Cookie**: Sets `access_token` as HttpOnly cookie (30 days expiry)
- **Errors**:
  - `401 Unauthorized`: Invalid credentials or inactive account

#### 3. Logout

**POST** `/auth/logout`

- **Description**: Clears the authentication cookie
- **Access**: Authenticated users
- **Response** (200 OK):
  ```json
  {
    "message": "Logged out successfully"
  }
  ```
- **Cookie**: Clears `access_token` cookie

#### 4. Get Current User

**GET** `/auth/me`

- **Description**: Returns information about the currently authenticated user
- **Access**: Authenticated users
- **Headers**: Cookie with `access_token`
- **Response** (200 OK):
  ```json
  {
    "user": {
      "id": "uuid",
      "email": "admin@example.com",
      "fullName": "John Doe",
      "role": "super_admin",
      "companyId": null,
      "isActive": true,
      "createdAt": "2024-01-01T00:00:00.000Z"
    }
  }
  ```
- **Errors**:
  - `401 Unauthorized`: Invalid or missing token

#### 5. Change Password

**PATCH** `/auth/change-password`

- **Description**: Allows authenticated users to change their password
- **Access**: Authenticated users
- **Request Body**:
  ```json
  {
    "currentPassword": "OldPassword123",
    "newPassword": "NewSecurePassword456"
  }
  ```
- **Response** (200 OK):
  ```json
  {
    "message": "Password changed successfully"
  }
  ```
- **Errors**:
  - `400 Bad Request`: Validation failed
  - `401 Unauthorized`: Current password is incorrect or account inactive
  - `400 Bad Request`: New password must be different from current password

### Authentication Flow

1. **Initial Setup**: Create super admin via `/auth/super-admin` (one-time only)
2. **Login**: User logs in via `/auth/login` → JWT token stored in HttpOnly cookie
3. **Authenticated Requests**: Include cookie automatically in subsequent requests
4. **Authorization**: Use `@Roles()` decorator to restrict endpoints by role
5. **Logout**: Clear cookie via `/auth/logout`

### Security Features

- **HttpOnly Cookies**: Prevents XSS attacks (JavaScript cannot access token)
- **Secure Flag**: Enabled in production (HTTPS only)
- **SameSite: Lax**: CSRF protection
- **Password Hashing**: Bcrypt with 10 salt rounds
- **JWT Expiry**: 30 days (configurable via `JWT_EXPIRES_IN`)

### Using RBAC in Your Code

```typescript
import { Controller, Get, UseGuards } from '@nestjs/common';
import { JwtAuthGuard } from './auth/guards/jwt-auth.guard';
import { RolesGuard } from './auth/guards/roles.guard';
import { Roles } from './auth/decorators/roles.decorator';

@Controller('example')
@UseGuards(JwtAuthGuard, RolesGuard)
export class ExampleController {
  @Get('admin-only')
  @Roles('super_admin', 'company_admin')
  adminOnly() {
    // Only super_admin and company_admin can access
  }
}
```

---
